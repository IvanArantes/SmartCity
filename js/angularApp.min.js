var app=angular.module("SmartCityApp",[]);app.controller("mapacontroller",function(a,b){a.kp="Led:Led1",a.ontology="LedArduino",a.token="963332f6a53f41e5b639a14e653eb694",a.markers=[],a.markersBkp=[],a.sessionKey=null,a.connection,a.markersMap=[],a.marker=[],a.queryLamp="select * from LedArduino ",$(function(){dwr.engine.setActiveReverseAjax(!1),dwr.engine.setTimeout(0),dwr.engine.setErrorHandler(function(a){alert(a)}),connection=new c});var c=function(){a.sessionKey,a.getSessionKey=function(){return a.sessionKey}};a.connect=function(b,c,d,e){sofia2.joinToken(d,c,function(b){null!=b&&null!=b.body.data&&1==b.body.ok?(a.sessionKey=b.sessionKey,"undefineddis"==typeof e||e(a.sessionKey)):alert("Error\n"+b.body.error)})},a.addInArray=function(b){for(var e,c=!0,d=0;d<a.markers.length&&1==c;)b.led==a.markers[d].led&&(c=!1,e=d),d++;c?a.markers.push(b):a.markers[e]=b},a.queryResultCall=function(b){if(null!=b)if(null!=b.body&&null!=b.body.data&&1==b.body.ok){var c=null;a.markers=[];for(var d=0;d<b.body.data.length;d++)c=JSON.stringify(b.body.data[d],void 0,2),0==a.markers.length?a.markers.push(JSON.parse(c).LedArduino):a.addInArray(JSON.parse(c).LedArduino);a.deleteMarkers(),a.setMarkers()}else a.resultbox=b.body.error;else a.resultbox="Sem resultado"},a.sendCustomMessage=function(b,c,d){null!=connection?(a.sessionKey=a.getSessionKey(),null!=a.sessionKey?sofia2.queryWithQueryType(c.replace(/[\n\r]+/g,"").replace(/\s{2,10}/g,""),b,"SQLLIKE",null,d):a.resultbox="por favor realiza um join"):a.resultbox="por favor realiza um join(connection)"},a.conectar=function(){a.connect(a.ontology,a.kp,a.token,function(a){console.log(a)})},a.desconectar=function(){null!=connection&&connection.leave(function(b){a.resultbox="desconectado"})},a.action=function(){a.sendCustomMessage(a.ontology,a.queryLamp,a.queryResultCall)},a.clonaArray=function(){for(var b=0;b<a.markers.length;b++)a.markersBkp[b]=a.markers[b]},a.map,a.marker,a.mapOptions={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,center:{lat:-16.673624,lng:-49.269078}},a.map=new google.maps.Map(document.getElementById("map"),a.mapOptions),a.geocoder=new google.maps.Geocoder,a.geocodeAddress=function(b){a.address=b,a.geocoder.geocode({address:b},function(b,c){if(c===google.maps.GeocoderStatus.OK){a.map.setCenter(b[0].geometry.location);new google.maps.Marker({map:a.map,animation:google.maps.Animation.DROP,position:a.results[0].geometry.location})}else alert("Não foram encontrados resultados: "+a.status)})},a.deleteMarkers=function(){a.clearMarkers(),a.markersMap=[]},a.clearArrayMarkers=function(){a.markers=[]},a.clearMarkers=function(){for(var b=0;b<a.markersMap.length;b++)a.markersMap[b].setMap(null)},a.setColor=function(a){return a>=30&&a<70?icon="img/lampada50.png":0==a?icon="img/lampada0.png":a>=70&&a<100?icon="img/lampada70.png":100==a?icon="img/lampada100.png":a>0&&a<30?icon="img/lampada30.png":void 0},a.setMarkers=function(){for(var b=new google.maps.InfoWindow,c=0;c<a.markers.length;c++){var d=a.markers[c].geometry.coordinates[0],e=a.markers[c].geometry.coordinates[1],f=new google.maps.LatLng(d,e);a.icon=a.setColor(a.markers[c].carga),console.log(icon),a.marker=new google.maps.Marker({position:f,map:a.map,title:a.markers[c].led,icon:a.icon});var g="<p>Nome do Sensor: "+a.markers[c].led+"</p><p>Latitude: "+d+"</p><p>Longitude: "+e+"</p><p>Data da modificação: "+a.markers[c].data_carga.$date.substring(0,10)+" "+a.markers[c].data_carga.$date.substring(11,19)+"</p><p>Potência: "+a.markers[c].carga+"</p>";google.maps.event.addListener(a.marker,"click",function(c,d){return function(){b.setContent(d),b.open(a.map,c)}}(a.marker,g)),a.markersMap.push(a.marker)}},window.setTimeout(a.conectar(),500),window.setTimeout(a.action,1e3),a.valueInterval=10;var d=b(a.action,1e3*a.valueInterval),e=b(a.conectar,1e3*a.valueInterval);a.$watch("valueInterval",function(){b.cancel(d),b.cancel(e),console.log("valor"+a.valueInterval),e=b(a.conectar,1e3*a.valueInterval),d=b(a.action,1e3*a.valueInterval)})});